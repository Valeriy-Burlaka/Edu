<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-12 result-container">
            <span id="result">0</span>
        </div>
    </div>
    <div class="row buttons">
        <div class="col col-3 button border-right top-side-button" id="clean" data-kind="operator" data-value="clean">AC</div>
        <div class="col col-3 button border-right top-side-button" id="plus-minus" data-value="+/-" data-kind="operator">&plus;/&minus;</div>
        <div class="col col-3 button border-right top-side-button" id="percent" data-value="%" data-kind="operator">%</div>
        <div class="col col-3 button right-side-button" data-value="/" data-kind="operator">
            <span>&divide;</span>
        </div>
    </div>
    <div class="row buttons">
        <div class="col col-3 button border-right" data-value="7" data-kind="number">7</div>
        <div class="col col-3 button border-right" data-value="8" data-kind="number">8</div>
        <div class="col col-3 button border-right" data-value="9" data-kind="number">9</div>
        <div class="col col-3 button right-side-button" id="times" data-value="*" data-kind="operator">
            <span>&times;</span>
        </div>
    </div>
    <div class="row buttons">
        <div class="col col-3 button border-right" data-value="4" data-kind="number">4</div>
        <div class="col col-3 button border-right" data-value="5" data-kind="number">5</div>
        <div class="col col-3 button border-right" data-value="6" data-kind="number">6</div>
        <div class="col col-3 button right-side-button" data-value="-" data-kind="operator">
            <span>&minus;</span>
        </div>
    </div>
    <div class="row buttons">
        <div class="col col-3 button border-right" data-value="1" data-kind="number">1</div>
        <div class="col col-3 button border-right" data-value="2" data-kind="number">2</div>
        <div class="col col-3 button border-right" data-value="3" data-kind="number">3</div>
        <div class="col col-3 button right-side-button" data-value="+" data-kind="operator">
            <span>&plus;</span>
        </div>
    </div>
    <div class="row buttons">
        <div class="col col-6 button border-right" id="zero-container" data-value="0" data-kind="number">
            <span >0</span>
        </div>
        <div class="col col-6" style="border-bottom-right-radius:4px">
            <div class="row" style="height:100%;">
                <div class="col col-6 button border-right" data-value="." data-kind="number">,</div>
                <div class="col col-6 button right-side-button" style="border-bottom-right-radius:4px" data-value="=" data-kind="operator">
                    <span>=</span>
                </div>
            </div>
        </div>
    </div>
</div>
<audio src="Funk.wav" type="audio/wav" id="error-sound"></audio>

<script>
"use strict";

const buttons = document.querySelectorAll(".button");
buttons.forEach( b => {
    b.addEventListener("mousedown", function mouseDown(e) {
        if (e.button == 0) {
            this.classList.add("pressed");
        }
    });
});
buttons.forEach( b => {
    b.addEventListener("mouseup", function mouseUp(e) {
        if (e.button == 0) {
            this.classList.remove("pressed");
        }
    });
});

let queue = [
    {kind: "number", value: "0"}
];


function lastItemInQueue() { return queue[queue.length-1]; };
function isLastANumberInQueue() { return lastItemInQueue().kind == "number"; };
function isLastAnOperatorInQueue() { return lastItemInQueue().kind == "operator"; };

function playErrorSound() {
    let sound = document.querySelector("#error-sound");
    sound.currentTime = 0;
    sound.play();
};

function highlightCurrentOperator(operator) {
    let allB = Array.from(buttons);
    allB.forEach(b => b.classList.remove("thicker-border"));
    let target = allB.filter(b => {
        return b.getAttribute("data-value") == operator;
    })[0];
    target.classList.add("thicker-border");
};

function blinkResultValue() {
    let result = document.querySelector("#result");
    result.classList.add("blinking");
    window.setTimeout(() => result.classList.remove("blinking"), 100);
};

function handleNumberInput(number) {
    let lastItem = lastItemInQueue();
    if (lastItem.kind == "number") {
        if (number != ".") {
            // single zero
            if (lastItem.value == "0") {
                lastItem.value = number;
            } else {
                lastItem.value += number;
            }
        // comma
        } else {
            if (lastItem.value.includes(".")) {
                playErrorSound();
            } else {
                lastItem.value += number;
            }
        }
    // 
    } else {
        if (number == ".") {
            number = "0.";
        }
        queue.push({kind: "number", value: number});
    }
};

let memorizedOp;

function evaluateSequence(seq) {
    console.dir(`Eval: memo: ${memorizedOp}`);
    let result;
    let kindSeq = seq.map(elt => elt.kind).join(",");
    console.info(`Handle ${kindSeq} case`);
    if (kindSeq == "number") {
        if (!memorizedOp) {
            blinkResultValue();
            result = seq[0];
        } else {
            let expr = seq[0].value + memorizedOp;
            result = {kind: "number", value: eval(expr).toString()}
        }  
    // E.g., "5*=". Interpreted as "5*5="
    } else if (kindSeq == "number,operator") {
        let expr = `${seq[0].value}${seq[1].value}${seq[0].value}`;
        memorizedOp = `${seq[1].value}${seq[0].value}`;
        // let expr = queue.map(elt => elt.value).join("") + queue[0].value;
        result = {kind: "number", value: eval(expr).toString()};
    } else if (kindSeq == "number,operator,number" || 
                kindSeq == "number,operator,number,operator,number" ) {        
        let expr = seq.map(elt => elt.value).join("");
        memorizedOp = `${seq[seq.length-2].value}${seq[seq.length-1].value}`;
        result = {kind: "number", value: eval(expr).toString()};
    }

    return result;
};

function operatorWeight(operator) {
    switch (operator) {
        case "+":
        case "-":
            return 1;
        case "*":
        case "/":
            return 2;
    }
};

function reverseSign(num) {
    if (num == "0") {}
    else if (num.startsWith("-")) {
        num = num.slice(1);
    } else {
        num = "-" + num;
    }
    return num;
};

function handleOperatorInput(operator) {
    let lastItem = lastItemInQueue();
    switch (operator) {
        case "=":
            console.log("Equals!");
            let res = evaluateSequence(queue);
            queue = [res];
            break;
        case "clean":
            console.log("Triggered clean!");
            break;
        case "+/-":
            console.log("Negative, bro!");
            if (lastItem.kind == "number") {
                lastItem.value = reverseSign(lastItem.value);
            } else {
                // last item is operator, so the item before last item should be a number
                let lastNumber = queue[queue.length-2];
                queue.push({kind: "number", value: reverseSign(lastNumber)});
            }
            break;
        case "%":
            console.log("Time for dividents, bro!");
            break;
        default:
            console.log(`Got a ${operator}, bro!`);
            highlightCurrentOperator(operator);
            if (lastItem.kind == "operator") {
                lastItem.value = operator;
            } else {
                queue.push({kind: "operator", value: operator});
            }
            blinkResultValue();

            let opsInQueue = queue.filter(i => i.kind == "operator");
            if (opsInQueue.length == 2) {
                console.log("2 operators in queue, hold on!");
                switch (operatorWeight(opsInQueue[0].value) - operatorWeight(opsInQueue[1].value)) {
                    case 1:
                    case 0:
                        let res = evaluateSequence(queue.slice(0, queue.length-1));
                        queue = [res, queue[queue.length-1]];
                        break;
                }
            } else if (opsInQueue.length > 2) {
                let res = evaluateSequence(queue.slice(0, queue.length-1));
                queue = [res, queue[queue.length-1]];
            }        
    }
};

function drawResult() {
    let result = document.querySelector("#result");
    let numbers = queue.filter( item => item.kind == "number" );
    let value = numbers[numbers.length-1].value;
    if (value.length > 7) {
        let baseFontSize = 48, baseMargin = 10;
        // {count_of_entered_numbers: font_size}
        let resultSizes = {
            8: 44, 9: 40, 10: 36, 11: 32, 12: 30, 13: 28, 14: 26,
            15: 24, 16: 22, 17: 21, 18: 20, 19: 19, 20: 18, 21: 17,
            22: 16, 23: 15, 24: 15, 25: 14, 26: 12, 27: 12, 28: 11,
            29: 11, 30: 11, 31: 10, 32: 10, 33: 9, 34: 9, 35: 9,
            36: 8, 37: 8, 38: 8
        };
        let newFontSize = resultSizes[value.length];
        let newMargin = baseMargin + (baseFontSize - newFontSize) / 2;
        
        result.style["font-size"] = `${newFontSize}px`;
        result.style["margin-top"] = `${newMargin}%`;
    }
    result.innerHTML = value;
}

function handleClick(e) {
    let kind = this.getAttribute("data-kind");
    let value = this.getAttribute("data-value");
    if (kind == "number") {
        handleNumberInput(value);
    } else {
        handleOperatorInput(value);
    }

    drawResult();
}

buttons.forEach( b => {
    b.addEventListener("click", handleClick);
})




</script>

</body>
</html>
